version: {{docker.compose.version}}
services:
  s3-source:
    image: springcloudstream/s3-source-kafka:{{stream.apps.version}}
    environment:
      - SPRING_CLOUD_FUNCTION_DEFINITION={{functionDefinition}}
      - FILE_CONSUMER_MODE={{consumerMode}}
      - S3_COMMON_ENDPOINT_URL={{s3.endpoint.url}}
      - S3_COMMON_PATH_STYLE_ACCESS=true
      - S3_SUPPLIER_REMOTE_DIR=bucket
      - S3_SUPPLIER_LIST_ONLY={{listOnly}}
      - CLOUD_AWS_STACK_AUTO=false
      - CLOUD_AWS_CREDENTIALS_ACCESS_KEY=minio
      - CLOUD_AWS_CREDENTIALS_SECRET_KEY=minio123
      - CLOUD_AWS_REGION_STATIC=us-east-1
      - SPRING_CLOUD_STREAM_BINDINGS_OUTPUT_DESTINATION=log
      - SPRING_CLOUD_STREAM_KAFKA_BINDER_BROKERS={{kafkaBootStrapServers}}
# For Task Launch Request
      - TASK_LAUNCH_REQUEST_ARG_EXPRESSIONS=filename=payload
      - TASK_LAUNCH_REQUEST_TASK_NAME=myTask
    extra_hosts:
      - minio:{{minioHost}}
  log-sink:
    image: springcloudstream/log-sink-kafka:{{stream.apps.version}}
    environment:
      - SPRING_CLOUD_STREAM_KAFKA_BINDER_BROKERS={{kafkaBootStrapServers}}
      - SPRING_CLOUD_STREAM_BINDINGS_INPUT_DESTINATION=log
      - SPRING_CLOUD_STREAM_BINDINGS_INPUT_GROUP=s3-source-tests